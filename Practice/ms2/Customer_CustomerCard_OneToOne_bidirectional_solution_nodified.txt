Customer model

package com.examly.springapp.model;

import com.fasterxml.jackson.annotation.JsonManagedReference;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.OneToOne;

@Entity
public class Customer {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int customerId;
    private String name;
    private String email;
    private String phone;

    @JsonManagedReference
    @OneToOne (mappedBy = "customer")
    CustomerCard customerCard;

    public int getCustomerId() {
        return customerId;
    }

    public void setCustomerId(int customerId) {
        this.customerId = customerId;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public CustomerCard getCustomerCard() {
        return customerCard;
    }

    public void setCustomerCard(CustomerCard customerCard) {
        this.customerCard = customerCard;
    }

    
}


//-------------------------------------------------------------------------------
CustomerCard model

package com.examly.springapp.model;
import java.time.LocalDate;

import com.fasterxml.jackson.annotation.JsonBackReference;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.OneToOne;

@Entity
public class CustomerCard {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int cardId;
    private String cardNumber;
    private LocalDate expirationDate;
    private String status; //active or inactive

    @JsonBackReference
    @OneToOne
    @JoinColumn(name ="customer_id")
    Customer customer;

    public int getCardId() {
        return cardId;
    }

    public void setCardId(int cardId) {
        this.cardId = cardId;
    }

    public String getCardNumber() {
        return cardNumber;
    }

    public void setCardNumber(String cardNumber) {
        this.cardNumber = cardNumber;
    }

    public LocalDate getExpirationDate() {
        return expirationDate;
    }

    public void setExpirationDate(LocalDate expirationDate) {
        this.expirationDate = expirationDate;
    }

    public String getStatus() {
        return status;
    }

    public void setStatus(String status) {
        this.status = status;
    }

    public Customer getCustomer() {
        return customer;
    }

    public void setCustomer(Customer customer) {
        this.customer = customer;
    }

}

//-------------------------------------------------------------------------------

package com.examly.springapp.exception;

public class CardAlreadyAssignedException extends RuntimeException {
    public CardAlreadyAssignedException(String msg)
    {
        super(msg);
    }
}


//-------------------------------------------------------------------------------
package com.examly.springapp.exception;

public class DuplicateEmailException extends RuntimeException {
    public DuplicateEmailException(String msg)
    {
        super(msg);
    }
}


//-------------------------------------------------------------------------------

package com.examly.springapp.exception;

public class InvalidException extends RuntimeException{
    public InvalidException(String msg)
    {
        super(msg);
    }

}

//-------------------------------------------------------------------------------


package com.examly.springapp.exception;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(DuplicateEmailException.class)
    public ResponseEntity<String> duplicateEmailException(DuplicateEmailException e)
    {
        return ResponseEntity.status(409).body(e.getMessage());
    }

    @ExceptionHandler(CardAlreadyAssignedException.class)
    public ResponseEntity<String> cardAlreadyAssignedException(CardAlreadyAssignedException e)
    {
        return ResponseEntity.status(409).body(e.getMessage());
    }

    @ExceptionHandler(InvalidException.class)
    public ResponseEntity<String> invalidException(InvalidException e)
    {
        return ResponseEntity.status(400).body(e.getMessage());
    }
}



//-------------------------------------------------------------------------------

Customer Repo 

package com.examly.springapp.repository;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import com.examly.springapp.model.Customer;

public interface CustomerRepo extends JpaRepository<Customer, Integer>{
    boolean existsByEmail(String email); 
   // Customer findByEmail(String email); //select c from Customer c where c.email = :email
    @Query("select c from Customer c order by c.name asc, c.phone desc")
    List<Customer> getAllInSorted();
   // List<Customer> findAllByOrderByNameAscPhoneDesc();
}

//-------------------------------------------------------------------------------

Customer Card Repo

package com.examly.springapp.repository;

import com.examly.springapp.model.CustomerCard;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;

public interface CustomerCardRepo extends JpaRepository<CustomerCard, Integer>{
    //@Query("select c from CustomerCard c where c.status = :status")
    List<CustomerCard> findAllByStatus(String status);
}

//------------------------------------------------------------
//Services

package com.examly.springapp.service;

import java.util.List;

import com.examly.springapp.model.Customer;

public interface CustomerService {

    Customer createCustomer(Customer customer);
    List<Customer> getAllCustomerSorted();
    Customer getCustomerByCustomerId(int customerId);
}
//-------------------------------------------------------------------------------


package com.examly.springapp.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.examly.springapp.exception.DuplicateEmailException;
import com.examly.springapp.exception.InvalidException;
import com.examly.springapp.model.Customer;
import com.examly.springapp.repository.CustomerRepo;

@Service
public class CustomerServiceImpl implements CustomerService {

    @Autowired
    CustomerRepo customerRepo;

@Override
public Customer createCustomer(Customer customer) {
     boolean exists = customerRepo.existsByEmail(customer.getEmail());

     if(exists)
     {
        throw new DuplicateEmailException("Customer with email "+customer.getEmail()+ " already exists");
     }

     if(!customer.getName().isEmpty() && !customer.getEmail().isEmpty() && !customer.getPhone().isEmpty())
     {
        return customerRepo.save(customer);
     }
     return null;
}

@Override
public List<Customer> getAllCustomerSorted() {
     return customerRepo.getAllInSorted();
}

@Override
public Customer getCustomerByCustomerId(int customerId) {
    
    // Customer c = customerRepo.findById(customerId).orElse(null);

    // if(c == null)
    // {
    //     throw new InvalidException("Customer with Id "+customerId+" not found");
    // }
    
    //return c;


    // direct method
    return customerRepo.findById(customerId).orElseThrow(() -> new InvalidException("Customer with Id "+customerId+" not found"));
  
    //return customerRepo.findById(customerId).orElse(null);    // if no exception
}
}


//-------------------------------------------------------------------------------

package com.examly.springapp.service;

import java.util.List;

import com.examly.springapp.model.CustomerCard;

public interface CustomerCardService {

    CustomerCard mapCardWithCustomer(int customerId, CustomerCard customerCard);
    List<CustomerCard> getCardsByStatus(String status);
    boolean deleteCardById(int cardId); 
    CustomerCard updateCard(int cardId, CustomerCard customerCard);
    
}

//-------------------------------------------------------------------------------

package com.examly.springapp.service;

import java.time.LocalDate;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.examly.springapp.exception.CardAlreadyAssignedException;
import com.examly.springapp.exception.InvalidException;
import com.examly.springapp.model.Customer;
import com.examly.springapp.model.CustomerCard;
import com.examly.springapp.repository.CustomerCardRepo;
import com.examly.springapp.repository.CustomerRepo;

@Service
public class CustomerCardServiceImpl implements CustomerCardService{

    @Autowired
    CustomerCardRepo cardRepo;

    @Autowired
    CustomerRepo customerRepo;

    @Override
    public CustomerCard mapCardWithCustomer(int customerId, CustomerCard customerCard) {
       Customer c = customerRepo.findById(customerId).orElse(null);
       if(c.getCustomerCard() != null)
       {
        throw new CardAlreadyAssignedException("Customer already has an assigned card");
       }
       customerCard.setCustomer(c);
       return cardRepo.save(customerCard);
    }


    @Override
    public List<CustomerCard> getCardsByStatus(String status) {
        return cardRepo.findAllByStatus(status);
    }


    @Override
    public boolean deleteCardById(int cardId) {
        if(cardRepo.existsById(cardId))
        {
            cardRepo.deleteById(cardId);
            return true;

        }
        return false;
    }


    @Override
    public CustomerCard updateCard(int cardId, CustomerCard customerCard) {
         // check expiration date is greater than todays date

         LocalDate today = LocalDate.now();
         if(customerCard.getExpirationDate().isBefore(today) || customerCard.getExpirationDate().equals(today))
         {
            throw new InvalidException("Invalid expiration date");
         }

         if(cardRepo.existsById(cardId))
         {
            CustomerCard og = cardRepo.findById(cardId).orElse(null);

            og.setCardNumber(customerCard.getCardNumber());
            og.setExpirationDate(customerCard.getExpirationDate());
            og.setStatus(customerCard.getStatus());

            return cardRepo.save(og);
         }
         return null;
    }


}

//-------------------------------------------------------------------------------
package com.examly.springapp.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.examly.springapp.model.Customer;
import com.examly.springapp.service.CustomerService;

@RestController
@RequestMapping("/api")
public class CustomerController {

    @Autowired
    CustomerService service;

    @PostMapping("/customer")
    public ResponseEntity<Customer> createCustomer(@RequestBody Customer customer)
    {
        Customer c = service.createCustomer(customer);
        if(c ==null)
        {
            return ResponseEntity.status(500).build();
        }
        return ResponseEntity.status(201).body(c);
    }

    @GetMapping("/customer/{customerId}")
    public ResponseEntity<Customer> getCustomerById(@PathVariable int customerId)
    {
        Customer c = service.getCustomerByCustomerId(customerId);
        if(c ==null)
        {
            return ResponseEntity.status(404).build();
        }
        return ResponseEntity.status(200).body(c);
    }

    @GetMapping("/customer")
    public ResponseEntity<List<Customer>> getAllCustomers()
    {
        List<Customer> c = service.getAllCustomerSorted();
        if(c.isEmpty())
        {
            return ResponseEntity.status(404).build();
        }
        return ResponseEntity.status(200).body(c);
    }
}

//-------------------------------------------------------------------------------
package com.examly.springapp.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.examly.springapp.model.CustomerCard;
import com.examly.springapp.service.CustomerCardService;


@RestController
@RequestMapping("/api")
public class CustomerCardController {

    @Autowired
    CustomerCardService service;

    @PostMapping("/customer/{customerId}/card")
    public ResponseEntity<CustomerCard> mapCardToCustomer(@PathVariable int customerId, @RequestBody CustomerCard customerCard)
    {
        CustomerCard c = service.mapCardWithCustomer(customerId, customerCard);

        if(c == null)
        {
            return ResponseEntity.status(500).build();
        }
        return ResponseEntity.status(201).body(c);
    }

    @GetMapping("/customercard/status/{status}")
    public ResponseEntity<List<CustomerCard>> getCardByStatus(@PathVariable String status)
    {
        List<CustomerCard> c = service.getCardsByStatus(status);
        if(c.isEmpty())
        {
            return ResponseEntity.status(404).build();
        }
        return ResponseEntity.status(200).body(c);
    }

    @DeleteMapping("/customercard/{cardId}")
    public ResponseEntity<String> deleteCard(@PathVariable int cardId)
    {
        boolean deleted = service.deleteCardById(cardId);

        if(deleted)
        {
            return ResponseEntity.status(200).body( "CustomerCard "+cardId+ " deleted successfully");
        }
        return ResponseEntity.status(404).body("404 not found");
    }

    @PutMapping("/customercard/{cardId}")
    public ResponseEntity<CustomerCard> updateCard(@PathVariable int cardId, @RequestBody CustomerCard customerCard)
    {
        CustomerCard c = service.updateCard(cardId, customerCard);
        {
            if(c == null)
            {
                return ResponseEntity.status(404).build();
            }
            return ResponseEntity.status(200).body(c);
        }
    }
}






